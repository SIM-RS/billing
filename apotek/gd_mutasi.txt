DELIMITER $$;

DROP PROCEDURE IF EXISTS `dbapotik`.`gd_mutasi`$$

CREATE DEFINER=`root`@`localhost` PROCEDURE `gd_mutasi`(unit_id_asal bigint, unit_id_tujuan bigint, a_fk_minta_id bigint, a_nokirim varchar(30), a_obat_id bigint, kp_id_asal int, kp_id_tujuan int, qty double, a_tipe_trans int, user_id bigint, a_status int, tgl varchar(10), tgl_act varchar(19))
BEGIN
  DECLARE done,selesai INT DEFAULT 0;
  DECLARE jml double;
  DECLARE ID,OBAT_ID,ID_LAMA,PBF_ID,UNIT_ID_KIRIM,UNIT_ID_TERIMA,KEPEMILIKAN_ID,USER_ID_KIRIM,USER_ID_TERIMA,HARI_J_TEMPO bigint;
  DECLARE NOKIRIM,NOTERIMA,NOBUKTI varchar(30);
  DECLARE TANGGAL_ACT datetime;
  DECLARE TANGGAL,TGL_J_TEMPO,EXPIRED date;
  DECLARE BATCH,KEMASAN varchar(50);
  DECLARE QTY_KEMASAN,QTY_PER_KEMASAN,QTY_SATUAN,QTY_SATUAN_LAMA,QTY_STOK,QTY_RETUR,HARGA_BELI_TOTAL,HARGA_BELI_SATUAN,NILAI_PAJAK double;
  DECLARE DISKON,EXTRA_DISKON,DISKON_TOTAL double;
  DECLARE JENIS,TIPE_TRANS,cSTATUS tinyint(1);
  DECLARE KET text;
  DECLARE cur1 CURSOR FOR select ap.ID,ap.OBAT_ID,ap.ID_LAMA,ap.PBF_ID,ap.UNIT_ID_KIRIM,ap.UNIT_ID_TERIMA,ap.KEPEMILIKAN_ID,ap.USER_ID_KIRIM,ap.USER_ID_TERIMA,ap.NOKIRIM,ap.NOTERIMA,ap.NOBUKTI,ap.TANGGAL_ACT,ap.TANGGAL,ap.TGL_J_TEMPO,ap.HARI_J_TEMPO,ap.BATCH,ap.EXPIRED,ap.QTY_KEMASAN,ap.KEMASAN,ap.QTY_PER_KEMASAN,ap.QTY_SATUAN,ap.QTY_SATUAN_LAMA,ap.QTY_STOK,ap.QTY_RETUR,ap.HARGA_BELI_TOTAL,ap.HARGA_BELI_SATUAN,ap.DISKON,ap.EXTRA_DISKON,ap.DISKON_TOTAL,ap.KET,ap.NILAI_PAJAK,ap.JENIS,ap.TIPE_TRANS,ap.STATUS from a_penerimaan ap where ap.UNIT_ID_TERIMA=unit_id_asal and ap.KEPEMILIKAN_ID=kp_id_asal and ap.OBAT_ID=a_obat_id and ap.QTY_STOK>0 and ap.STATUS=1 order by ap.TANGGAL,ap.ID;
  DECLARE cur2 CURSOR FOR select ap.ID,ap.OBAT_ID,ap.ID_LAMA,ap.PBF_ID,ap.UNIT_ID_KIRIM,ap.UNIT_ID_TERIMA,ap.KEPEMILIKAN_ID,ap.USER_ID_KIRIM,ap.USER_ID_TERIMA,ap.NOKIRIM,ap.NOTERIMA,ap.NOBUKTI,ap.TANGGAL_ACT,ap.TANGGAL,ap.TGL_J_TEMPO,ap.HARI_J_TEMPO,ap.BATCH,ap.EXPIRED,ap.QTY_KEMASAN,ap.KEMASAN,ap.QTY_PER_KEMASAN,ap.QTY_SATUAN,ap.QTY_SATUAN_LAMA,ap.QTY_STOK,ap.QTY_RETUR,ap.HARGA_BELI_TOTAL,ap.HARGA_BELI_SATUAN,ap.DISKON,ap.EXTRA_DISKON,ap.DISKON_TOTAL,ap.KET,ap.NILAI_PAJAK,ap.JENIS,ap.TIPE_TRANS,ap.STATUS from a_penerimaan ap where ap.UNIT_ID_TERIMA=unit_id_asal and ap.OBAT_ID=a_obat_id and ap.QTY_STOK>0 and ap.STATUS=1 order by ap.TANGGAL,ap.ID;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
  set jml=qty;
  IF (kp_id_asal<>0) THEN
	OPEN cur1;
  ELSE
	OPEN cur2;
  END IF;
  WHILE ((NOT done) and (selesai<>1)) do
  IF (kp_id_asal<>0) THEN
    FETCH cur1 INTO ID,OBAT_ID,ID_LAMA,PBF_ID,UNIT_ID_KIRIM,UNIT_ID_TERIMA,KEPEMILIKAN_ID,USER_ID_KIRIM,USER_ID_TERIMA,NOKIRIM,NOTERIMA,NOBUKTI,TANGGAL_ACT,TANGGAL,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,QTY_SATUAN,QTY_SATUAN_LAMA,QTY_STOK,QTY_RETUR,HARGA_BELI_TOTAL,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,KET,NILAI_PAJAK,JENIS,TIPE_TRANS,cSTATUS;
  ELSE
    FETCH cur2 INTO ID,OBAT_ID,ID_LAMA,PBF_ID,UNIT_ID_KIRIM,UNIT_ID_TERIMA,KEPEMILIKAN_ID,USER_ID_KIRIM,USER_ID_TERIMA,NOKIRIM,NOTERIMA,NOBUKTI,TANGGAL_ACT,TANGGAL,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,QTY_SATUAN,QTY_SATUAN_LAMA,QTY_STOK,QTY_RETUR,HARGA_BELI_TOTAL,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,KET,NILAI_PAJAK,JENIS,TIPE_TRANS,cSTATUS;
  END IF;
    IF NOT done THEN
       IF QTY_STOK >= jml THEN
	  set selesai=1;
          INSERT INTO a_penerimaan(OBAT_ID,ID_LAMA,FK_MINTA_ID,PBF_ID,UNIT_ID_KIRIM,UNIT_ID_TERIMA,KEPEMILIKAN_ID,USER_ID_KIRIM,USER_ID_TERIMA,NOKIRIM,NOTERIMA,NOBUKTI,TANGGAL_ACT,TANGGAL,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,QTY_SATUAN,QTY_SATUAN_LAMA,QTY_STOK,QTY_RETUR,HARGA_BELI_TOTAL,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,KET,NILAI_PAJAK,JENIS,TIPE_TRANS,STATUS) VALUES (OBAT_ID,ID,a_fk_minta_id,PBF_ID,unit_id_asal,unit_id_tujuan,kp_id_tujuan,user_id,0,a_nokirim,'',NOBUKTI,tgl_act,tgl,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,jml,'',jml,0,jml*HARGA_BELI_SATUAN,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,'',NILAI_PAJAK,JENIS,a_tipe_trans,a_status);
	  update a_penerimaan ap set QTY_STOK=QTY_STOK-jml where ap.ID=ID;
       ELSE
	  set jml=jml-QTY_STOK;
          INSERT INTO a_penerimaan(OBAT_ID,ID_LAMA,FK_MINTA_ID,PBF_ID,UNIT_ID_KIRIM,UNIT_ID_TERIMA,KEPEMILIKAN_ID,USER_ID_KIRIM,USER_ID_TERIMA,NOKIRIM,NOTERIMA,NOBUKTI,TANGGAL_ACT,TANGGAL,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,QTY_SATUAN,QTY_SATUAN_LAMA,QTY_STOK,QTY_RETUR,HARGA_BELI_TOTAL,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,KET,NILAI_PAJAK,JENIS,TIPE_TRANS,STATUS) VALUES (OBAT_ID,ID,a_fk_minta_id,PBF_ID,unit_id_asal,unit_id_tujuan,kp_id_tujuan,user_id,0,a_nokirim,'',NOBUKTI,tgl_act,tgl,TGL_J_TEMPO,HARI_J_TEMPO,BATCH,EXPIRED,QTY_KEMASAN,KEMASAN,QTY_PER_KEMASAN,QTY_STOK,'',QTY_STOK,0,QTY_STOK*HARGA_BELI_SATUAN,HARGA_BELI_SATUAN,DISKON,EXTRA_DISKON,DISKON_TOTAL,'',NILAI_PAJAK,JENIS,a_tipe_trans,a_status);
	  update a_penerimaan ap set QTY_STOK=0 where ap.ID=ID;
       END IF;
    END IF;
  END WHILE;
  IF (kp_id_asal<>0) THEN
	CLOSE cur1;
  ELSE
	CLOSE cur2;
  END IF;
END$$

DELIMITER ;$$