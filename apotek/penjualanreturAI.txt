DELIMITER $$;

DROP TRIGGER `dbapotik`.`penjualanreturAI`$$

create trigger `penjualanreturAI` AFTER INSERT on `a_penjualan_retur` 
for each row BEGIN
DECLARE done INT DEFAULT 0;   
DECLARE vstok INT DEFAULT 0;  
DECLARE Cur CURSOR FOR SELECT stok_after from a_kartustok where 
OBAT_ID=NEW.OBAT_ID and KEPEMILIKAN_ID=(select KEPEMILIKAN_ID from a_penerimaan,a_penjualan,a_penjualan_retur
where a_penjualan_retur.PENJUALAN_ID=a_penjualan.ID and a_penjualan.PENERIMAAN_ID=a_penerimaan.ID and
RETUR_PENJUALAN_ID=new.RETUR_PENJUALAN_ID) and UNIT_ID=new.unit_id order by tgl_act desc limit 1;
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000'  SET done = 1; 
IF  (NEW.STATUS=1)  then
	OPEN Cur;   
	WHILE Done <> 1  DO      
	FETCH Cur INTO vstok;      
	 END WHILE;
	CLOSE Cur;
INSERT INTO A_KARTUSTOK(OBAT_ID,KEPEMILIKAN_ID,UNIT_ID,TGL_TRANS,TGL_ACT,NO_BUKTI,STOK_BEFOR,DEBET,KREDIT,STOK_AFTER,KET) VALUES (NEW.OBAT_ID,(select KEPEMILIKAN_ID from a_penerimaan,a_penjualan,a_penjualan_retur
where a_penjualan_retur.PENJUALAN_ID=a_penjualan.ID and a_penjualan.PENERIMAAN_ID=a_penerimaan.ID and
RETUR_PENJUALAN_ID=new.RETUR_PENJUALAN_ID)
,new.UNIT_ID,NEW.TGL,now(),NEW.NO_RETUR,vstok,-1*NEW.QTY,0,vstok-NEW.QTY,concat('retur ',NEW.NO_RETUR));
end if;
END;
$$

DELIMITER ;$$